name: HuggingFace Keep Alive

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="üöÄ <b>HuggingFace ‰øùÊ¥ª‰ªªÂä°ÂºÄÂßã</b>%0A‚è∞ Êó∂Èó¥: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

      - name: Wake up Space 1
        id: space1
        run: |
          url="https://qiyuelian2424-canary-1b-v2-dev.hf.space"
          name="canary-1b-v2-dev"
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "result=‚ùå" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="üîÑ <b>$name</b>%0AÁä∂ÊÄÅÁ†Å: $http_code"
          
          sleep 30

      - name: Wake up Space 2
        id: space2
        run: |
          url="https://sibacohu-duorenyundong.hf.space"
          name="duorenyundong"
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "result=‚ùå" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="üîÑ <b>$name</b>%0AÁä∂ÊÄÅÁ†Å: $http_code"
          
          sleep 30

      - name: Wake up Space 3
        id: space3
        run: |
          url="https://anikaednerarter50-granite-docling-258m-demo.hf.space"
          name="granite-docling-258m"
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "result=‚ùå" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="üîÑ <b>$name</b>%0AÁä∂ÊÄÅÁ†Å: $http_code"

      - name: Send summary notification
        if: always()
        run: |
          r1="${{ steps.space1.outputs.result }}"
          r2="${{ steps.space2.outputs.result }}"
          r3="${{ steps.space3.outputs.result }}"
          c1="${{ steps.space1.outputs.code }}"
          c2="${{ steps.space2.outputs.code }}"
          c3="${{ steps.space3.outputs.code }}"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="üìä <b>‰øùÊ¥ª‰ªªÂä°ÂÆåÊàê</b>%0A%0A$r1 canary-1b-v2-dev ($c1)%0A$r2 duorenyundong ($c2)%0A$r3 granite-docling-258m ($c3)%0A%0A‚è∞ $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
