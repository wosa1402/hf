name: HuggingFace Keep Alive

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Random delay before start
        run: |
          delay=$((RANDOM % 15 + 1))
          echo "éšæœºå»¶è¿Ÿ $delay åˆ†é’Ÿåå¼€å§‹..."
          sleep ${delay}m

      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>HuggingFace ä¿æ´»ä»»åŠ¡å¼€å§‹</b>%0Aâ° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

      # ============ Space 1 ============
      # è‡ªå®šä¹‰åç§°: åœ¨ä¸‹é¢çš„ name= åé¢ä¿®æ”¹æ˜¾ç¤ºåç§°
      - name: Wake up Space 1
        id: space1
        run: |
          url="https://qiyuelian2424-canary-1b-v2-dev.hf.space"
          name="Teldrive"  # â† è‡ªå®šä¹‰åç§°
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=âœ…" >> $GITHUB_OUTPUT
          else
            echo "result=âŒ" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸ”„ <b>$name</b>%0AçŠ¶æ€ç : $http_code"
          
          # éšæœºå»¶è¿Ÿ 10-40 ç§’
          sleep $((RANDOM % 30 + 10))

      # ============ Space 2 ============
      - name: Wake up Space 2
        id: space2
        run: |
          url="https://sibacohu-duorenyundong.hf.space"
          name="é…’é¦†ï¼ˆæ³¨å†Œç‰ˆï¼‰"  # â† è‡ªå®šä¹‰åç§°
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=âœ…" >> $GITHUB_OUTPUT
          else
            echo "result=âŒ" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸ”„ <b>$name</b>%0AçŠ¶æ€ç : $http_code"
          
          sleep $((RANDOM % 30 + 10))

      # ============ Space 3 ============
      - name: Wake up Space 3
        id: space3
        run: |
          url="https://link.066677.xyz"
          name="Linkwarden"  # â† è‡ªå®šä¹‰åç§°
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            "$url")
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "result=âœ…" >> $GITHUB_OUTPUT
          else
            echo "result=âŒ" >> $GITHUB_OUTPUT
          fi
          echo "code=$http_code" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸ”„ <b>$name</b>%0AçŠ¶æ€ç : $http_code"

      - name: Send summary notification
        if: always()
        run: |
          r1="${{ steps.space1.outputs.result }}"
          r2="${{ steps.space2.outputs.result }}"
          r3="${{ steps.space3.outputs.result }}"
          c1="${{ steps.space1.outputs.code }}"
          c2="${{ steps.space2.outputs.code }}"
          c3="${{ steps.space3.outputs.code }}"
          n1="${{ steps.space1.outputs.name }}"
          n2="${{ steps.space2.outputs.name }}"
          n3="${{ steps.space3.outputs.name }}"
          
          # ç»Ÿè®¡æˆåŠŸæ•°é‡
          success=0
          total=3
          [ "$r1" = "âœ…" ] && ((success++))
          [ "$r2" = "âœ…" ] && ((success++))
          [ "$r3" = "âœ…" ] && ((success++))
          
          if [ "$success" -eq "$total" ]; then
            summary="ğŸ‰ å…¨éƒ¨æˆåŠŸ"
          elif [ "$success" -eq 0 ]; then
            summary="ğŸ’¥ å…¨éƒ¨å¤±è´¥"
          else
            summary="âš ï¸ éƒ¨åˆ†æˆåŠŸ ($success/$total)"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸ“Š <b>ä¿æ´»ä»»åŠ¡å®Œæˆ</b>%0A%0A$r1 $n1 ($c1)%0A$r2 $n2 ($c2)%0A$r3 $n3 ($c3)%0A%0A$summary%0Aâ° $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
