name: HuggingFace Keep Alive

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Random delay before start
        run: |
          delay=$((RANDOM % 15 + 1))
          echo "éšæœºå»¶è¿Ÿ $delay åˆ†é’Ÿåå¼€å§‹..."
          sleep ${delay}m

      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>HuggingFace ä¿æ´»ä»»åŠ¡å¼€å§‹</b>%0Aâ° $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

      - name: Wake up all Spaces
        run: |
          # ==========================================
          # ğŸ”§ é…ç½®åŒºï¼šæ·»åŠ æ–° Space åªéœ€è¦åŠ ä¸€è¡Œï¼
          # æ ¼å¼ï¼šåç§°|åœ°å€
          # ==========================================
          SPACES=(
            "Teldrive|https://qiyuelian2424-canary-1b-v2-dev.hf.space"
            "é…’é¦†ï¼ˆæ³¨å†Œç‰ˆï¼‰|https://sibacohu-duorenyundong.hf.space"
            "Linkwarden|https://link.066677.xyz"
            "Tg Singer|https://sibacohu-demo-playground.hf.space"
          )
          # ==========================================
          
          results=""
          success=0
          total=${#SPACES[@]}
          
          for item in "${SPACES[@]}"; do
            name="${item%%|*}"
            url="${item##*|}"
            
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
              "$url")
            
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
              status="âœ…"
              success=$((success + 1))
            else
              status="âŒ"
            fi
            
            results="${results}${status} ${name} (${http_code})%0A"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="HTML" \
              -d text="ğŸ”„ <b>$name</b>%0AçŠ¶æ€ç : $http_code"
            
            # éšæœºå»¶è¿Ÿ 10-40 ç§’
            sleep $((RANDOM % 30 + 10))
          done
          
          # ç”Ÿæˆæ±‡æ€»
          if [ "$success" -eq "$total" ]; then
            summary="ğŸ‰ å…¨éƒ¨æˆåŠŸ"
          elif [ "$success" -eq 0 ]; then
            summary="ğŸ’¥ å…¨éƒ¨å¤±è´¥"
          else
            summary="âš ï¸ éƒ¨åˆ†æˆåŠŸ ($success/$total)"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="ğŸ“Š <b>ä¿æ´»ä»»åŠ¡å®Œæˆ</b>%0A%0A${results}%0A${summary}%0Aâ° $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
