name: HuggingFace Keep Alive - Instant

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>HuggingFace ä¿æ´»ä»»åŠ¡å¼€å§‹</b>%0A%0Aâ° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

      - name: Wake up Hugging Face Spaces
        id: wake_up
        shell: bash
        run: |
          urls="https://qiyuelian2424-canary-1b-v2-dev.hf.space
          https://sibacohu-duorenyundong.hf.space
          https://anikaednerarter50-granite-docling-258m-demo.hf.space"
          
          success_count=0
          fail_count=0
          total=0
          
          # è®¡ç®—æ€»æ•°
          for url in $urls; do
            ((total++))
          done
          
          for url in $urls; do
            space_name=$(echo "$url" | sed 's|https://||' | sed 's|.hf.space||')
            
            # å‘é€å¼€å§‹æ£€æµ‹é€šçŸ¥
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="HTML" \
              -d text="ğŸ”„ <b>æ­£åœ¨å”¤é†’:</b> ${space_name}"
            
            # å°è¯•è®¿é—®å¹¶è·å–HTTPçŠ¶æ€ç 
            http_code=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              --max-time 60 \
              "$url")
            
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
              status="âœ… æˆåŠŸ"
              emoji="âœ…"
              ((success_count++))
            else
              status="âŒ å¤±è´¥"
              emoji="âŒ"
              ((fail_count++))
            fi
            
            # å‘é€ç»“æœé€šçŸ¥
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="HTML" \
              -d text="${emoji} <b>${space_name}</b>%0AçŠ¶æ€ç : ${http_code}%0Aç»“æœ: ${status}"
            
            # éšæœºå»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ª
            individual_delay=$((RANDOM % 60 + 5))
            sleep "${individual_delay}s"
          done
          
          echo "success_count=${success_count}" >> $GITHUB_OUTPUT
          echo "fail_count=${fail_count}" >> $GITHUB_OUTPUT
          echo "total=${total}" >> $GITHUB_OUTPUT

      - name: Send summary notification
        if: always()
        run: |
          success="${{ steps.wake_up.outputs.success_count }}"
          fail="${{ steps.wake_up.outputs.fail_count }}"
          total="${{ steps.wake_up.outputs.total }}"
          
          # è®¾ç½®é»˜è®¤å€¼é˜²æ­¢ç©ºå€¼
          success=${success:-0}
          fail=${fail:-0}
          total=${total:-0}
          
          if [ "$fail" -eq 0 ] && [ "$total" -gt 0 ]; then
            summary_emoji="ğŸ‰"
            summary_status="å…¨éƒ¨æˆåŠŸ"
          elif [ "$success" -eq 0 ]; then
            summary_emoji="ğŸ’¥"
            summary_status="å…¨éƒ¨å¤±è´¥"
          else
            summary_emoji="âš ï¸"
            summary_status="éƒ¨åˆ†æˆåŠŸ"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${summary_emoji} <b>HuggingFace ä¿æ´»ä»»åŠ¡å®Œæˆ</b>%0A%0AğŸ“Š ç»Ÿè®¡ç»“æœ:%0Aâœ… æˆåŠŸ: ${success}/${total}%0AâŒ å¤±è´¥: ${fail}/${total}%0A%0AğŸ·ï¸ çŠ¶æ€: ${summary_status}%0Aâ° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
